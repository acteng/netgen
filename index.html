<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Generate Route Network Datasets from Origin-Destination Data • netgen</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Generate Route Network Datasets from Origin-Destination Data">
<meta name="description" content="This package takes OD data and outputs route networks.">
<meta property="og:description" content="This package takes OD data and outputs route networks.">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">netgen</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="articles/schoolroutes.html">SchoolRoutes: An approach for data-driven investment in safe routes to school</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/acteng/netgen/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="generate-origin-destination-data-for-route-network-generation">Generate origin-destination data for route network generation<a class="anchor" aria-label="anchor" href="#generate-origin-destination-data-for-route-network-generation"></a>
</h1></div>
<p>The input of the network generation approaches demonstrated in this repo is origin-destionation data. There are many sources of OD data, see the documentation in the <a href="data-raw/odgen.qmd">odgen.qmd</a> for a way to generate synthetic OD data that we’ll use in the reproducible code below.</p>
</div>
<div class="section level1">
<h1 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h1>
<p>For reproduducibility, we have setup a Docker container with all the dependencies needed to run the code below. The easiest way to run the code and develop new code in this repo may be with GitHub Codespaces which can be accessed via <a href="https://github.com/codespaces/new?hide_repo_select=true&amp;ref=24-package-all-software-in-single-image&amp;repo=826170244&amp;skip_quickstart=true&amp;machine=standardLinux32gb&amp;devcontainer_path=.devcontainer%2Fdevcontainer.json&amp;geo=EuropeWest" class="external-link">github.com/codespaces/new</a>.</p>
<p>Pull the latest version of the container with the following:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="ex">docker</span> pull ghcr.io/geocompx/docker:rust</span></code></pre></div>
<p>Then open the project with the <a href=".devcontainer">.devcontainer.json</a> file in Visual Studio Code (see <a href="https://code.visualstudio.com/docs/devcontainers/containers" class="external-link">VS Code docs</a> for more on this).</p>
<p>That should allow you to run the code in the README with the following command:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">quarto</span><span class="fu">::</span><span class="fu"><a href="https://quarto-dev.github.io/quarto-r/reference/quarto_render.html" class="external-link">quarto_render</a></span><span class="op">(</span><span class="st">"README.qmd"</span><span class="op">)</span></span></code></pre></div>
<p>If you haven’t got project running in a container, you can run the code below in your local environment.</p>
<details><p>To run the code below you need to have R and Docker installed. After you have installed R, you can install the packages we’ll use as follows:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install pak if not already installed:</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"pak"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"pak"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">pkgs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sf"</span>, <span class="st">"tidyverse"</span>, <span class="st">"tmap"</span>, <span class="st">"pak"</span><span class="op">)</span></span>
<span><span class="va">pkgs_to_install</span> <span class="op">=</span> <span class="va">pkgs</span><span class="op">[</span><span class="op">!</span><span class="va">pkgs</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/installed.packages.html" class="external-link">installed.packages</a></span><span class="op">(</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">pkgs_to_install</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">pak</span><span class="fu">::</span><span class="fu"><a href="https://pak.r-lib.org/reference/pkg_install.html" class="external-link">pkg_install</a></span><span class="op">(</span><span class="va">pkgs_to_install</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># Load the packages with vapply:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">pkgs</span>, <span class="va">require</span>, <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">logical</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, character.only <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>       sf tidyverse      tmap       pak </span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>     <span class="cn">TRUE</span>      <span class="cn">TRUE</span>      <span class="cn">TRUE</span>      <span class="cn">TRUE</span> </span></code></pre></div>
<p>We will also install a couple of package that are not on CRAN:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pak</span><span class="fu">::</span><span class="fu"><a href="https://pak.r-lib.org/reference/pkg_install.html" class="external-link">pkg_install</a></span><span class="op">(</span><span class="st">"acteng/netgen"</span><span class="op">)</span></span>
<span><span class="fu">pak</span><span class="fu">::</span><span class="fu"><a href="https://pak.r-lib.org/reference/pkg_install.html" class="external-link">pkg_install</a></span><span class="op">(</span><span class="st">"Urban-Analytics-Technology-Platform/od2net/r"</span><span class="op">)</span></span></code></pre></div>
<!-- ::: {.panel-tabset group="language"}
&#10;## R -->
</details><p>After getting the software installed, load packages we’ll use as follows:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-tmap/tmap" class="external-link">tmap</a></span><span class="op">)</span></span>
<span><span class="co"># # Get the datasets, see: https://github.com/acteng/netgen/releases/tag/v0.1.0</span></span>
<span><span class="co"># Automate data download if you have gh installed and authorised with:</span></span>
<span><span class="co"># theme void:</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<!-- ## Python
&#10;```python
# import pandas as pd
# import geopandas as gpd
#
# # Get the datasets we'll use with os and subprocess:
# import subprocess
# subprocess.run(["gh", "release", "download", "v0.1.0"])
```
&#10;:::
&#10;
&#10;::: {.panel-tabset group="language"}
&#10;## R
&#10;## Python
&#10;```python
# od = pd.read_csv("res_output.csv")
# od.head()
# # TBC
```
&#10;:::
&#10;-->
</div>
<div class="section level1">
<h1 id="data-import-and-visualisation">Data import and visualisation<a class="anchor" aria-label="anchor" href="#data-import-and-visualisation"></a>
</h1>
<p>It’s worth importing and visualising the OD datasets before routing and network generation stages.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.html" class="external-link">system</a></span><span class="op">(</span><span class="st">"gh release list"</span><span class="op">)</span></span>
<span><span class="va">od</span> <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="st">"res_output.csv"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">od</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="co"># A tibble: 6 × 3</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>  O              D trips_modelled</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>  <span class="sc">&lt;</span>chr<span class="sc">&gt;</span>      <span class="er">&lt;</span>dbl<span class="sc">&gt;</span>          <span class="er">&lt;</span>dbl<span class="sc">&gt;</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a><span class="dv">1</span> E01013335 <span class="dv">121266</span>          <span class="fl">6.37</span> </span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a><span class="dv">2</span> E01013336 <span class="dv">121266</span>          <span class="fl">3.26</span> </span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a><span class="dv">3</span> E01013337 <span class="dv">121266</span>          <span class="fl">4.57</span> </span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a><span class="dv">4</span> E01013338 <span class="dv">121266</span>          <span class="fl">6.46</span> </span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a><span class="dv">5</span> E01013339 <span class="dv">121266</span>          <span class="fl">2.95</span> </span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a><span class="dv">6</span> E01013340 <span class="dv">121266</span>          <span class="fl">0.124</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">od_geo</span> <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="st">"res_output.geojson"</span><span class="op">)</span></span>
<span><span class="va">od_geo</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="va">trips_modelled</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/desire-lines-r-1.png"></p>
</div>
<div class="section level1">
<h1 id="od2net">od2net<a class="anchor" aria-label="anchor" href="#od2net"></a>
</h1>
<p>Building on code in the <a href="https://urban-analytics-technology-platform.github.io/od2net/r/" class="external-link">od2net</a> R package, we can generate the files needed for the network generation stage.</p>
<p>After you have installed the package, prepare the input datasets and run the network-generation code to generate output.geojson and output.pmtiles outputs:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">origin_zones</span> <span class="op">=</span> <span class="fu">netgen</span><span class="fu">::</span><span class="va"><a href="reference/zones_york.html">zones_york</a></span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">origin_zones</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a> [<span class="dv">1</span>] <span class="st">"LSOA21CD"</span>     <span class="st">"LSOA21NM"</span>     <span class="st">"total"</span>        <span class="st">"f0_to_15"</span>     <span class="st">"f16_to_29"</span>   </span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a> [<span class="dv">6</span>] <span class="st">"f30_to_44"</span>    <span class="st">"f45_to_64"</span>    <span class="st">"f65_and_over"</span> <span class="st">"m0_to_15"</span>     <span class="st">"m16_to_29"</span>   </span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>[<span class="dv">11</span>] <span class="st">"m30_to_44"</span>    <span class="st">"m45_to_64"</span>    <span class="st">"m65_and_over"</span> <span class="st">"geometry"</span>    </span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">origin_zones</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="st">"name"</span></span>
<span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_write.html" class="external-link">write_sf</a></span><span class="op">(</span><span class="va">origin_zones</span>, <span class="st">"input/zones_york.geojson"</span>, delete_dsn <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu">od2net</span><span class="fu">::</span><span class="fu">make_osm</span><span class="op">(</span>zones_file <span class="op">=</span> <span class="st">"input/zones_york.geojson"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>Reading layer <span class="st">`</span><span class="at">zones' from data source </span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="at">  </span><span class="st">`</span><span class="sc">/</span>home<span class="sc">/</span>robin<span class="sc">/</span>github<span class="sc">/</span>acteng<span class="sc">/</span>netgen<span class="sc">/</span>input<span class="sc">/</span>zones.geojson<span class="st">' using driver `GeoJSON'</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>Simple feature collection with <span class="dv">121</span> features and <span class="dv">13</span> fields</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>Geometry type<span class="sc">:</span> MULTIPOLYGON</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>Dimension<span class="sc">:</span>     XY</span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>Bounding box<span class="sc">:</span>  xmin<span class="sc">:</span> <span class="sc">-</span><span class="fl">1.2237</span> ymin<span class="sc">:</span> <span class="fl">53.87459</span> xmax<span class="sc">:</span> <span class="sc">-</span><span class="fl">0.9196789</span> ymax<span class="sc">:</span> <span class="fl">54.05661</span></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>Geodetic CRS<span class="sc">:</span>  WGS <span class="dv">84</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">od2net</span><span class="fu">::</span><span class="fu">make_origins</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Optionally, get elevation data:</span></span>
<span><span class="co"># netgen:::make_elevation()</span></span>
<span><span class="va">destinations</span> <span class="op">=</span> <span class="fu">netgen</span><span class="fu">::</span><span class="va"><a href="reference/destinations_york.html">destinations_york</a></span> <span class="co"># Provided in the R package</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">destinations</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="st">"name"</span></span>
<span><span class="va">destinations</span> <span class="op">=</span> <span class="va">destinations</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">destinations</span><span class="op">$</span><span class="va">name</span><span class="op">)</span> <span class="op">=</span> <span class="st">"character"</span></span>
<span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_write.html" class="external-link">write_sf</a></span><span class="op">(</span><span class="va">destinations</span>, <span class="st">"input/destinations.geojson"</span>, delete_dsn <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># Save the OD dataset:</span></span>
<span><span class="va">od</span> <span class="op">=</span> <span class="va">od_geo</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">O</span>, to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">D</span><span class="op">)</span>, count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">trips_modelled</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_csv</a></span><span class="op">(</span><span class="va">od</span>, <span class="st">"input/od.csv"</span>, quote <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span></span></code></pre></div>
<p>To install the <code>od2net</code> package, run the following:</p>
<pre class="shell"><code>cargo install --locked --git https://github.com/Urban-Analytics-Technology-Platform/od2net</code></pre>
<p>If you are running the code in a container, you should already have the <code>od2net</code> package installed. Check this with the following:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.html" class="external-link">system</a></span><span class="op">(</span><span class="st">"od2net --version"</span><span class="op">)</span></span></code></pre></div>
<!-- If you don't have it, you can copy the path /root/.cargo/bin/od2net to /usr/local/bin/ as follows: -->
<p>The config file is as follows:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="st">"config.json"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span>sep <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>{</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>  <span class="st">"requests"</span><span class="sc">:</span> {</span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>    <span class="st">"description"</span><span class="sc">:</span> <span class="st">"Test data for SchoolRoutes project."</span>,</span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>    <span class="st">"pattern"</span><span class="sc">:</span> {</span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a>      <span class="st">"ZoneToPoint"</span><span class="sc">:</span> {</span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a>        <span class="st">"zones_path"</span><span class="sc">:</span> <span class="st">"zones.geojson"</span>,</span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a>        <span class="st">"destinations_path"</span><span class="sc">:</span> <span class="st">"destinations.geojson"</span>,</span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a>        <span class="st">"csv_path"</span><span class="sc">:</span> <span class="st">"od.csv"</span>,</span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a>         <span class="st">"origin_zone_centroid_fallback"</span><span class="sc">:</span> false</span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a>      }</span>
<span id="cb18-11"><a href="#cb18-11" tabindex="-1"></a>    },</span>
<span id="cb18-12"><a href="#cb18-12" tabindex="-1"></a>    <span class="st">"origins_path"</span><span class="sc">:</span> <span class="st">"buildings.geojson"</span>,</span>
<span id="cb18-13"><a href="#cb18-13" tabindex="-1"></a>    <span class="st">"destinations_path"</span><span class="sc">:</span> <span class="st">"destinations.geojson"</span></span>
<span id="cb18-14"><a href="#cb18-14" tabindex="-1"></a>  },</span>
<span id="cb18-15"><a href="#cb18-15" tabindex="-1"></a>  <span class="st">"cost"</span><span class="sc">:</span> <span class="st">"Distance"</span>,</span>
<span id="cb18-16"><a href="#cb18-16" tabindex="-1"></a>  <span class="st">"uptake"</span><span class="sc">:</span> <span class="st">"Identity"</span>,</span>
<span id="cb18-17"><a href="#cb18-17" tabindex="-1"></a>  <span class="st">"lts"</span><span class="sc">:</span> <span class="st">"BikeOttawa"</span></span>
<span id="cb18-18"><a href="#cb18-18" tabindex="-1"></a>}</span></code></pre></div>
<p>Then run the following code to generate the network:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.html" class="external-link">system</a></span><span class="op">(</span><span class="st">"od2net config.json --rng-seed 42"</span><span class="op">)</span></span></code></pre></div>
<p>See below how to run it with Docker if you’re not running these commands in the .devcontainer and you don’t have od2net installed.</p>
<details><p>Run the tool with Docker as follows:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="co"># On Linux:</span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a><span class="fu">sudo</span> docker run <span class="at">-v</span> <span class="va">$(</span><span class="bu">pwd</span><span class="va">)</span>:/app ghcr.io/urban-analytics-technology-platform/od2net:main /app/config.json  <span class="at">--rng-seed</span> 42</span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a><span class="co"># On Windows:</span></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">-v</span> %cd%:/app ghcr.io/urban-analytics-technology-platform/od2net:main /app/config.json  <span class="at">--rng-seed</span> 42</span></code></pre></div>
</details><p>After that you should see the following in the output folder:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_tree.html" class="external-link">dir_tree</a></span><span class="op">(</span><span class="st">"output"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a>output</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>├── counts.csv</span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a>├── failed_requests.geojson</span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a>├── output.geojson</span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a>├── rnet.pmtiles</span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a>└── rnet_output_osrm_overline.geojson</span></code></pre></div>
<p>From that point you can visualise the pmtiles in the website at <a href="https://od2net.org" class="external-link">od2net.org</a> or other front-end application, as shown below.</p>
<div class="section level2">
<h2 id="minimal-od2net-example">Minimal od2net example<a class="anchor" aria-label="anchor" href="#minimal-od2net-example"></a>
</h2>
<p>For the purposes of testing it’s worth</p>
</div>
<div class="section level2">
<h2 id="adjusting-uptake-functions">Adjusting uptake functions<a class="anchor" aria-label="anchor" href="#adjusting-uptake-functions"></a>
</h2>
<p>The example above visualises <em>all</em> trips to school, not just active travel trips.</p>
</div>
<div class="section level2">
<h2 id="other-approaches-to-network-generation">Other approaches to network generation<a class="anchor" aria-label="anchor" href="#other-approaches-to-network-generation"></a>
</h2>
<p>An advantage of <code>od2net</code> is that it can generate the network and routes in a single step. For other approaches, we need to calculate the routes first, as shown below.</p>
<details></details>
</div>
</div>
<div class="section level1">
<h1 id="routing">Routing<a class="anchor" aria-label="anchor" href="#routing"></a>
</h1>
<p>There are many ways to calculate routes. The simplest in many cases will be to calculate them with a routing engine. Let’s do that with interfaces to the OSRM routing engine in the first instance. Note: if you use the <code>od2net</code> approach, you can do the routing and network generation stage in a single step, see below for more on that.</p>
<div class="section level2">
<h2 id="osrm-basic">OSRM: basic<a class="anchor" aria-label="anchor" href="#osrm-basic"></a>
</h2>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">od_geo_top_100</span> <span class="op">=</span> <span class="va">od_geo</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_max</a></span><span class="op">(</span><span class="va">trips_modelled</span>, n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> </span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">routes_osrm_minimal</span> <span class="op">=</span> <span class="fu">stplanr</span><span class="fu">::</span><span class="fu">route</span><span class="op">(</span></span>
<span>  l <span class="op">=</span> <span class="va">od_geo_top_100</span>,</span>
<span>  route_fun <span class="op">=</span> <span class="fu">stplanr</span><span class="fu">::</span><span class="va">route_osrm</span>,</span>
<span>  osrm.profile <span class="op">=</span> <span class="st">"foot"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">routes_osrm_minimal</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.3</span>, size <span class="op">=</span> <span class="fl">9</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/osrm-basic-1.png"></p>
</div>
<div class="section level2">
<h2 id="locally-hosted-osrm">Locally hosted OSRM<a class="anchor" aria-label="anchor" href="#locally-hosted-osrm"></a>
</h2>
<p>We can spin-up a local OSRM server to calculate routes as <a href="https://github.com/Project-OSRM/osrm-backend#using-docker" class="external-link">follows</a>:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">location</span> <span class="op">=</span> <span class="fu">osmextract</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/osmextract/reference/oe_match.html" class="external-link">oe_match</a></span><span class="op">(</span></span>
<span>  <span class="va">od_geo_top_100</span> <span class="op">|&gt;</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">st_union</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu">osmextract</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/osmextract/reference/oe_download.html" class="external-link">oe_download</a></span><span class="op">(</span></span>
<span>    <span class="va">location</span><span class="op">$</span><span class="va">url</span>,</span>
<span>    file_basename <span class="op">=</span> <span class="st">"osm.pbf"</span>,</span>
<span>    download_directory <span class="op">=</span> <span class="st">"."</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Then with the system shell:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">-t</span> <span class="at">-v</span> <span class="st">"</span><span class="va">${PWD}</span><span class="st">:/data"</span> ghcr.io/project-osrm/osrm-backend osrm-extract <span class="at">-p</span> /opt/car.lua /data/geofabrik_osm.pbf <span class="kw">||</span> <span class="bu">echo</span> <span class="st">"osrm-extract failed"</span></span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">-t</span> <span class="at">-v</span> <span class="st">"</span><span class="va">${PWD}</span><span class="st">:/data"</span> ghcr.io/project-osrm/osrm-backend osrm-extract <span class="at">-p</span> /opt/car.lua /data/geofrabik_osm.osm.pbf <span class="kw">||</span> <span class="bu">echo</span> <span class="st">"osrm-extract failed"</span></span></code></pre></div>
<p>That should generate something like:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a>[<span class="dv">2024-08-27</span>T15<span class="sc">:</span><span class="dv">00</span><span class="sc">:</span><span class="fl">31.786775132</span>] [info] Expansion<span class="sc">:</span> <span class="dv">766813</span> nodes<span class="sc">/</span>sec and <span class="dv">382310</span> edges<span class="sc">/</span>sec</span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>[<span class="dv">2024-08-27</span>T15<span class="sc">:</span><span class="dv">00</span><span class="sc">:</span><span class="fl">31.786776903</span>] [info] To prepare the data <span class="cf">for</span> routing, run<span class="sc">:</span> .<span class="sc">/</span>osrm<span class="sc">-</span>contract <span class="st">"/data/geofabrik_osm"</span></span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a>[<span class="dv">2024-08-27</span>T15<span class="sc">:</span><span class="dv">00</span><span class="sc">:</span><span class="fl">31.836550204</span>] [info] RAM<span class="sc">:</span> peak bytes used<span class="sc">:</span> <span class="dv">532934656</span></span></code></pre></div>
<p>Note the process used 532934656 bytes (532.9 MB) of RAM.</p>
<p>Then:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">-t</span> <span class="at">-v</span> <span class="st">"</span><span class="va">${PWD}</span><span class="st">:/data"</span> ghcr.io/project-osrm/osrm-backend osrm-partition /data/geofabrik_osm.osrm <span class="kw">||</span> <span class="bu">echo</span> <span class="st">"osrm-partition failed"</span></span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">-t</span> <span class="at">-v</span> <span class="st">"</span><span class="va">${PWD}</span><span class="st">:/data"</span> ghcr.io/project-osrm/osrm-backend osrm-customize /data/geofabrik_osm.osrm <span class="kw">||</span> <span class="bu">echo</span> <span class="st">"osrm-customize failed"</span></span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">-t</span> <span class="at">-i</span> <span class="at">-p</span> 5000:5000 <span class="at">-v</span> <span class="st">"</span><span class="va">${PWD}</span><span class="st">:/data"</span> ghcr.io/project-osrm/osrm-backend osrm-routed <span class="at">--algorithm</span> mld /data/geofabrik_osm</span></code></pre></div>
<p>Check it is alive as follows:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.html" class="external-link">system</a></span><span class="op">(</span><span class="st">'curl "http://127.0.0.1:5000/route/v1/driving/13.388860,52.517037;13.385983,52.496891?steps=true"'</span><span class="op">)</span></span></code></pre></div>
<p>Now we can run all the routes:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">routes_osrm_2</span> <span class="op">=</span> <span class="fu">stplanr</span><span class="fu">::</span><span class="fu">route</span><span class="op">(</span></span>
<span>  l <span class="op">=</span> <span class="va">od_geo</span>,</span>
<span>  route_fun <span class="op">=</span> <span class="fu">stplanr</span><span class="fu">::</span><span class="va">route_osrm</span>,</span>
<span>  osrm.profile <span class="op">=</span> <span class="st">"foot"</span>,</span>
<span>  osrm.server <span class="op">=</span> <span class="st">"http://127.0.0.1:5000/"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_write.html" class="external-link">write_sf</a></span><span class="op">(</span><span class="va">routes_osrm_2</span>, <span class="st">"routes_osrm_2.geojson"</span>, delete_dsn <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.html" class="external-link">system</a></span><span class="op">(</span><span class="st">"gh release upload v0.1.0 routes_osrm_2.geojson"</span><span class="op">)</span></span></code></pre></div>
<p>Let’s visualise the routes:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">routes_osrm_2</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.3</span>, size <span class="op">=</span> <span class="fl">9</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/osrm-locally-hosted-1.png"></p>
</div>
</div>
<div class="section level1">
<h1 id="network-generation">Network generation<a class="anchor" aria-label="anchor" href="#network-generation"></a>
</h1>
<div class="section level2">
<h2 id="overline">Overline<a class="anchor" aria-label="anchor" href="#overline"></a>
</h2>
<p>The <code>overline()</code> function in the R package stplanr is one way to to generate route networks:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">routes_osrm_2</span><span class="op">)</span></span>
<span><span class="va">rnet</span> <span class="op">=</span> <span class="fu">stplanr</span><span class="fu">::</span><span class="fu">overline</span><span class="op">(</span><span class="va">routes_osrm_2</span>, attrib <span class="op">=</span> <span class="st">"trips_modelled"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">rnet</span><span class="op">)</span></span></code></pre></div>
<p>A disadvantage of this approach is that it’s computational resource-intensive and takes a long time. An in-progress is <code>od2net</code>.</p>

</div>
</div>
<div class="section level1">
<h1 id="comparing-od2net-and-overline-outputs">Comparing od2net and overline outputs<a class="anchor" aria-label="anchor" href="#comparing-od2net-and-overline-outputs"></a>
</h1>
</div>

  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://cloud.r-project.org/package=netgen" class="external-link">View on CRAN</a></li>
<li><a href="https://github.com/acteng/netgen/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/acteng/netgen/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing netgen</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Robin Lovelace <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0001-5679-6536" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
</ul>
</div>



  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Robin Lovelace.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
