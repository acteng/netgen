---
title: Generate origin-destination data for route network generation
#| eval: false
#| echo: false
format: gfm
execute: 
  echo: false
  message: false
  warning: false
---

The input of the network generation approaches demonstrated in this repo is origin-destionation data.
There are many sources of OD data, see [odgen](odgen.qmd) for a way to generate synthetic OD data that we'll use in the reproducible code below.

# Setup

```{r}
#| include: false
pkgs = c("sf", "tidyverse", "tmap", "reticulate")
pkgs_to_install = pkgs[!pkgs %in% installed.packages()]
if (length(pkgs_to_install) > 0) {
  install.packages(pkgs_to_install)
}
# Install geopandas:
reticulate::py_install("geopandas")
```

::: {.panel-tabset group="language"}

## R

<!---
 jn: I would suggest to use specific packages from tidyverse instead of attaching the whole tidyverse 

rl: Why? Tidyverse is popular and it makes life easy.
Also that's the approach in the teaching materials.
For the book and for software development that's another matter but for this blog post I think it's fine.
--->

```{r}
library(sf)
library(tidyverse)
library(tmap)
# Get the datasets we'll use
system("gh release download v0.1.0")
# theme void:
theme_set(theme_void())
```

## Python

```{python}
import pandas as pd
import geopandas as gpd

# Get the datasets we'll use with os and subprocess:
import subprocess
subprocess.run(["gh", "release", "download", "v0.1.0"])
```

:::

# Data import and visualisation

It's worth importing and visualising the OD datasets before routing and network generation stages.

::: {.panel-tabset group="language"}

## R

```{r}
#| label: desire-lines-r
od = read_csv("res_output.csv")
head(od)
od_geo = sf::read_sf("res_output.geojson")
od_geo |>
  ggplot() +
  geom_sf(aes(alpha = trips_modelled))
```

## Python

```{python}
od = pd.read_csv("res_output.csv")
od.head()
# TBC
```

:::

# Routing

There are many ways to calculate routes.
The simplest in many cases will be to calculate them with a routing engine.
Let's do that with interfaces to the OSRM routing engine in the first instance.

## OSRM: basic

```{r}
routes_osrm_minimal_exists = file.exists("routes_osrm_minimal.geojson")
```

```{r eval=!routes_osrm_minimal_exists}
od_geo_top_10 = od_geo |>
  slice_max(trips_modelled, n = 10) 
routes_osrm_minimal = stplanr::route(
  l = od_geo_top_10,
  route_fun = stplanr::route_osrm,
  osrm.profile = "foot"
)
```

```{r eval=!routes_osrm_minimal_exists}
#| echo: false
sf::write_sf(routes_osrm_minimal, "routes_osrm_minimal.geojson", delete_dsn = TRUE)
```

```{r}
routes_osrm_minimal = sf::read_sf("routes_osrm_minimal.geojson")
```

```{r}
#| label: osrm-basic
routes_osrm_minimal |>
  ggplot() +
  geom_sf(alpha = 0.3)
```


```{r}
#| eval: false
routes_osrm_1 = stplanr::route(
  l = od_geo,
  route_fun = stplanr::route_osrm,
  osrm.profile = "foot"
)
```


```{r}
#| eval: false
#| label: save-routes
sf::st_write(routes_osrm_1, "routes_osrm_1.geojson")
```

